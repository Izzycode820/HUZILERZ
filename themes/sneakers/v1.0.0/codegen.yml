# GraphQL Code Generation for Storefront Theme
# Apollo Client v4 with TypedDocumentNode
# Follows Apollo's recommended configuration
#
# Apollo recommends NOT using client preset with Apollo Client
# Instead use: typescript + typescript-operations + typed-document-node
#
# Usage:
# import { useQuery } from '@apollo/client'
# import { GetProductsDocument } from './__generated__/getProducts.generated'
# const { data } = useQuery(GetProductsDocument)

ignoreNoDocuments: true

# IMPORTANT: Why we use JSON file instead of URL introspection
#
# Problem: Direct URL introspection fails with "Decorated type deeper than introspection query"
# - Admin side (workspace/store/graphql/) works fine with URL introspection
# - Storefront side (workspace/storefront/graphql/) crashes during introspection
# - Root cause: Unknown - both use graphene, same backend setup
# - Error occurs in directive type nesting when graphql-js tries to build client schema
#
# Solution: Use pre-generated introspection JSON file
# - Bypasses live introspection
# - Works perfectly for codegen (generates all types + hooks)
# - Only downside: Manual regeneration when backend schema changes
#
# HOW TO REGENERATE storefront-schema.json (run from this directory):
#
# curl -X POST http://localhost:8000/api/workspaces/storefront/graphql/ \
#   -H "Content-Type: application/json" \
#   -d '{"query":"query IntrospectionQuery{__schema{queryType{name}mutationType{name}types{...FullType}directives{name description locations args{...InputValue}}}}fragment FullType on __Type{kind name description fields(includeDeprecated:true){name description args{...InputValue}type{...TypeRef}isDeprecated deprecationReason}inputFields{...InputValue}interfaces{...TypeRef}enumValues(includeDeprecated:true){name description isDeprecated deprecationReason}possibleTypes{...TypeRef}}fragment InputValue on __InputValue{name description type{...TypeRef}defaultValue}fragment TypeRef on __Type{kind name ofType{kind name ofType{kind name ofType{kind name ofType{kind name ofType{kind name ofType{kind name ofType{kind name}}}}}}}}"}' \
#   > storefront-schema.json
#
# When to regenerate:
# - After adding/modifying GraphQL types in backend/workspace/storefront/graphql/types/
# - After adding/modifying queries in backend/workspace/storefront/graphql/queries/
# - After adding/modifying mutations in backend/workspace/storefront/graphql/mutations/
# - Basically: anytime you change the storefront GraphQL schema
#
schema:
  - storefront-schema.json

documents:
  # - "src/services/customer/**/*.graphql"
  # - "src/services/categories/**/*.graphql"
  # - "src/services/products/**/*.graphql"
  # - "src/services/discounts/**/*.graphql"
   - "src/services/checkout/**/*.graphql"
   - "src/services/cart/**/*.graphql"
  # - "src/services/settings/**/*.graphql"
  # - "src/services/puck/**/*.graphql"


generates:
  # Base TypeScript types
  src/types/graphql/graphql-base.ts:
    plugins:
      - "typescript"
    config:
      # Apollo Client best practices
      skipTypename: false
      nonOptionalTypename: true
      declarationKind: "interface"
      defaultScalarType: unknown
      # Scalar mappings
      scalars:
        DateTime: string
        UUID: string
        JSON: Record<string, any>
        Decimal: string  # Backend returns Decimal as string, not number
        Upload: File
      # Use null for nullable fields (Apollo recommendation)
      avoidOptionals:
        field: true
        inputValue: false
        object: false
        defaultValue: false
      # Allow undefined for optional input fields
      maybeValue: T | null

  # Typed operations co-located with .graphql files
  src/services/:
    preset: "near-operation-file"
    presetConfig:
      baseTypesPath: ../types/graphql/graphql-base.ts
      extension: .generated.ts
      folder: __generated__
    plugins:
      - "typescript-operations"
      - "typed-document-node"
    config:
      skipTypename: false
      nonOptionalTypename: true
      preResolveTypes: true
      declarationKind: "interface"
      defaultScalarType: unknown
      scalars:
        DateTime: string
        UUID: string
        JSON: Record<string, any>
        Decimal: string  # Backend returns Decimal as string, not number
        Upload: File
      avoidOptionals:
        field: true
        inputValue: false
        object: false
        defaultValue: false
      maybeValue: T | null

hooks:
  afterAllFileWrite:
    - prettier --write

{% extends "admin/base_site.html" %}
{% load static %}

{% block extrastyle %}
<style>
    .action-card {
        background: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .action-card h3 {
        margin-top: 0;
        color: #333;
        border-bottom: 2px solid #417690;
        padding-bottom: 10px;
    }

    .action-card p {
        color: #666;
        margin: 15px 0;
    }

    .action-button {
        background: #417690;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
    }

    .action-button:hover {
        background: #2d5468;
    }

    .action-button.danger {
        background: #dc3545;
    }

    .action-button.danger:hover {
        background: #c82333;
    }

    .form-group {
        margin: 15px 0;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
    }

    .form-group input {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }

    .info-box {
        background: #d1ecf1;
        border: 1px solid #bee5eb;
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
        color: #0c5460;
    }

    .warning-box {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 15px;
        margin: 20px 0;
        color: #856404;
    }
</style>
{% endblock %}

{% block content %}
<h1>Tenant Lookup Cache Management</h1>

<div class="info-box">
    <strong>Cache Purpose:</strong> The tenant lookup cache stores hostname to workspace mappings for fast resolution.
    This cache is critical for performance and is automatically invalidated on deployments and domain changes.
</div>

<!-- Warm All Caches -->
<div class="action-card">
    <h3>Warm Cache for All Workspaces</h3>
    <p>
        Pre-populate the cache with all active workspaces. This is useful after a cache flush or system restart.
        This operation may take several seconds depending on the number of workspaces.
    </p>

    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="warm_all">
        <button type="submit" class="action-button">Warm All Caches</button>
    </form>
</div>

<!-- Invalidate Specific Workspace -->
<div class="action-card">
    <h3>Invalidate Cache for Specific Workspace</h3>
    <p>
        Clear the cache for a specific workspace by ID. Use this when you need to force a cache refresh
        for a particular workspace without affecting others.
    </p>

    <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="invalidate_workspace">

        <div class="form-group">
            <label for="workspace_id">Workspace ID (UUID):</label>
            <input type="text" id="workspace_id" name="workspace_id" placeholder="e.g., 123e4567-e89b-12d3-a456-426614174000" required>
        </div>

        <button type="submit" class="action-button">Invalidate Workspace Cache</button>
    </form>
</div>

<!-- Cache Statistics -->
<div class="action-card">
    <h3>Cache Statistics</h3>
    <p>
        Monitor cache performance and hit rates through your cache backend (Redis).
        Use Redis CLI or monitoring tools for detailed statistics.
    </p>

    <div class="warning-box">
        <strong>Note:</strong> Cache statistics are available through your Redis monitoring dashboard.
        Common metrics to monitor:
        <ul>
            <li>Cache hit rate (should be > 90%)</li>
            <li>Memory usage</li>
            <li>Eviction rate</li>
            <li>Key count</li>
        </ul>
    </div>
</div>

<!-- Cache TTL Information -->
<div class="action-card">
    <h3>Cache TTL Settings</h3>
    <p>Current TTL (Time To Live) configurations:</p>
    <ul>
        <li><strong>Hostname Lookups:</strong> 1 hour (3600 seconds)</li>
        <li><strong>Workspace Data:</strong> 30 minutes (1800 seconds)</li>
        <li><strong>Custom Domains:</strong> 2 hours (7200 seconds)</li>
    </ul>

    <p>
        Cache entries are automatically invalidated when:
        <ul>
            <li>A theme is deployed/published</li>
            <li>Custom domain is added/removed</li>
            <li>Workspace subdomain changes</li>
            <li>Infrastructure status changes</li>
        </ul>
    </p>
</div>

<!-- Best Practices -->
<div class="action-card">
    <h3>Cache Management Best Practices</h3>
    <ul>
        <li><strong>Warm cache</strong> after system deployments or major updates</li>
        <li><strong>Monitor hit rates</strong> - low hit rates indicate caching issues</li>
        <li><strong>Invalidate selectively</strong> - avoid flushing entire cache unless necessary</li>
        <li><strong>Set alerts</strong> for high eviction rates or memory pressure</li>
        <li><strong>Review TTLs</strong> periodically based on usage patterns</li>
    </ul>
</div>

<div class="info-box" style="margin-top: 30px;">
    <p><strong>Need Help?</strong> Refer to the hosting service documentation for more details on cache management and troubleshooting.</p>
</div>

{% endblock %}
